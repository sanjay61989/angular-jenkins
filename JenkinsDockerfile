pipeline {
    tools {
        dockerTool 'docker'  // Use the Docker tool configured in Jenkins
        nodejs 'nodejs20'
    }
    agent any

    parameters {
        booleanParam(name: 'BUILD_MFE_SHELL', defaultValue: false, description: 'Build mfe-shell')
        booleanParam(name: 'BUILD_GYM_TRACKER', defaultValue: false, description: 'Build gym-tracker')
        booleanParam(name: 'BUILD_MEAL_PLANNER', defaultValue: false, description: 'Build meal-planner')
    }
    stages {
        stage('Cleanup Workspace') {
            steps {
                cleanWs() // This clears the workspace before the build starts
            }
        }
        stage('Clone Repositories') {
            steps {
                script {
                    if (params.BUILD_MFE_SHELL) {
                        sh 'git clone https://github.com/sanjay61989/mfe-shell.git'
                    }
                    if (params.BUILD_GYM_TRACKER) {
                        sh 'git clone https://github.com/sanjay61989/gym-tracker.git'
                    }
                    if (params.BUILD_MEAL_PLANNER) {
                        sh 'git clone https://github.com/sanjay61989/meal-planner.git'
                    }
                }
            }
        }
        stage('Build Projects') {
            steps {
                script {
                    if (params.BUILD_MFE_SHELL) {
                        dir('mfe-shell') {
                            sh 'npm install'
                            sh 'npm run build'
                            sh 'mkdir -p /tmp/build/mfe-shell'
                            sh 'cp -rf dist/shell/browser/* /tmp/build/mfe-shell'
                        }
                    }
                    if (params.BUILD_GYM_TRACKER) {
                        dir('gym-tracker') {
                            sh 'npm install'
                            sh 'npm run build'
                            sh 'mkdir -p /tmp/build/mfe-shell/gym-tracker'
                            sh 'cp -rf dist/gym-tracker/browser/* /tmp/build/mfe-shell/gym-tracker'
                        }
                    }
                    if (params.BUILD_MEAL_PLANNER) {
                        dir('meal-planner') {
                            sh 'npm install'
                            sh 'npm run build'
                            sh 'mkdir -p /tmp/build/mfe-shell/meal-planner'
                            sh 'cp -r dist/meal-planner/browser/* /tmp/build/mfe-shell/meal-planner'
                        }
                    }
                }
            }
        }
        stage('Build Nginx Image') {
            steps {
                script {
                    dir('mfe-shell') {
                        sh 'sudo chmod 666 /var/run/docker.sock'
                        sh 'docker build -t my-nginx-image .'
                    }
                }
            }
        }
        stage('Deploy') {
            steps {
                script {
                    // Add your deployment steps here
                    sh 'docker run -d -p 80:80 my-nginx-image'
                }
            }
        }
    }
}
